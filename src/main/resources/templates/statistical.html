<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{_layout}">
<div layout:fragment="content" class="bg-white px-6 pt-6 border-b" style="width: -webkit-fill-available">
    <h2 class="text-xl font-semibold mb-4">Báo cáo và thống kê</h2>

    <div th:if="${vaiTro == 'Admin'}" class="mb-6">
        <select required name="chinhanh" onchange="selectChiNhanh()" id="chinhanh" class="px-4 py-2 mr-4 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-700">
            <option th:each="item : ${chinhanhs}"
                    th:value="${item.maCN}"
                    th:text="${item.tenCN + ' ' + item.diaChi}">
            </option>
        </select>
    </div>
    <div style="align-items:end" class="row mb-6">
        <div class="col-4">
            <label class="block mb-1 font-medium text-gray-700">Từ</label>
            <input type="date" id="startDate" th:value="${startDate}"
                   class="w-full border px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" />
        </div>

        <div class="col-4">
            <label class="block mb-1 font-medium text-gray-700">Đến</label>
            <input type="date" id="endDate" th:value="${endDate}"
                   class="w-full border px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" />
        </div>
        <div class="col-2 text-center">
            <button onclick="search()" class=" p-2 rounded-md transition text-white bg-green-500">Tìm kiếm</button>
        </div>
        <div class="col-2">
            <button onclick="printTab()" class=" p-2 rounded-md transition text-white bg-blue-500">In báo cáo</button>
        </div>
    </div>


    <div style="width:90%" class=" bg-white bg-white mb-4">
        <div>
            <canvas id="myChart"></canvas>
        </div>
    </div>
</div>

<div layout:fragment="scripts">
    <script th:inline="javascript">
    let labels = /*[[${labels}]]*/ [];
    let values = /*[[${values}]]*/ [];
    let maCN = /*[[${maCN}]]*/ '';
    let tenCN = /*[[${tenCN}]]*/ '';
    let diaChi = /*[[${diaChi}]]*/ '';
    let listInHoaDon = /*[[${listInHoaDon}]]*/ [];
    let list = /*[[${list}]]*/ [];
    let startDate = /*[[${startDate}]]*/ '';
    let endDate = /*[[${endDate}]]*/ '';

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('StatisticalId')?.classList.add('font-bold', 'text-blue-800');
        $('#chinhanh').val(maCN);
    });
    const ctx = document.getElementById('myChart');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Doanh thu',
        data: values,
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

    function search(){
        let startDate = $('#startDate').val();
        let endDate = $('#endDate').val();
        let value = $('#chinhanh').val() ?? maCN;
        if(startDate && endDate){
           document.location.href = '/statisticalFilter/' + value + `?startDate=${startDate}&endDate=${endDate}`;
        }
        else document.location.href = '/statistical/' + value;
        //console.log(startDate);
        //document.location.href = '/statisticalFilter/' + value + `?startDate=${startDate}&endDate=${endDate}`;
    }

    function selectChiNhanh(){
        let value = $('#chinhanh').val();
        //document.location.href = '/statistical/' + value;
    }

    function printTab(){
      const now = new Date();

      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = now.getFullYear();

      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');

      let dateNow = `${day}/${month}/${year} – ${hours}:${minutes}`;

      let htmlDate = startDate != "yyyy-MM-dd" ? `<p>Từ ngày: ${startDate}  –  Đến ngày: ${endDate}</p>` : '';

      let htmlBody = '';
      list.forEach((item,index) => {
            htmlBody += `
                <tr>
                    <td>${++index}</td>
                    <td>${item.label}</td>
                    <td>${item.value}</td>
                </tr>
            `;
      });

      let html = `<!DOCTYPE html>
                        <html lang="vi">
                        <head>
                          <meta charset="UTF-8">
                          <title>Báo Cáo</title>
                          <style>

                              body {
                              font-family: Arial, sans-serif;
                              margin: 40px;
                            }
                            .d-flex {
                              display: flex;
                              justify-content: space-between;
                              align-items: flex-start;
                            }
                            .left-header, .right-header {
                              width: 48%;
                            }
                            .left-header h2 {
                              margin: 0;
                              font-size: 24px;
                            }
                            .right-header p {
                              margin: 4px 0;
                              font-size: 14px;
                              text-align: right;
                            }
                            .company-center {
                              text-align: center;
                              margin-top: 20px;
                            }

                                table {
                              width: 100%;
                              border-collapse: collapse;
                              font-size: 14px;
                            }
                            th, td {
                              border: 1px solid #000;
                              padding: 6px;
                              text-align: center;
                            }
                            th {
                              background-color: #f0f0f0;
                            }
                          </style>
                        </head>
                        <body>

                          <div class="d-flex">
                            <div class="left-header">
                              <h2>Banani Coffee</h2>
                              <strong>${tenCN}</strong><br>
                              <p>${diaChi}</p>
                            </div>
                            <div class="right-header">
                              <p style="display:none">Hotline: 0334.594.822</p>
                              <p>Ngày giờ xuất: ${dateNow}</p>
                            </div>
                          </div>

                          <div class="company-center">
                            <h3>BÁO CÁO DOANH THU BÁN HÀNG</h3>
                            ${htmlDate}
                          </div>
                        <table>
                            <thead>
                              <tr>
                                <th>STT</th>
                                <th>Ngày</th>
                                <th>Tổng tiền</th>
                              </tr>
                            </thead>
                            <tbody>
                                ${htmlBody}
                            </tbody>
                          </table>
                        </body>
                        </html>
                        `;
            const newTab = window.open('', '_blank');
            newTab.document.open();
            newTab.document.write(html);
            newTab.document.close();

            setTimeout(() => {
                newTab.print();
            }, 300);
    }
    </script>
</div>
</html>