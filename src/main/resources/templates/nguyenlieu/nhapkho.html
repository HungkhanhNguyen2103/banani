<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{_layout}">
<head>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
</head>

<body>

<div layout:fragment="content" class="bg-white px-6 pt-6 border-b" style="">

    <h2 class="text-xl font-semibold mb-4">Nhập kho</h2>

    <div class="container mt-4">

        <!-- TAB MENU -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="week-tab"
                        data-bs-toggle="tab" data-bs-target="#week"
                        type="button">Danh sách nhập</button>
            </li>

            <li class="nav-item">
                <button class="nav-link" id="excel-tab"
                        data-bs-toggle="tab" data-bs-target="#excel"
                        type="button">Cập nhật đơn</button>
            </li>
        </ul>


        <!-- TAB CONTENT-->
        <div class="tab-content" id="myTabContent">

            <!-- TAB 1 -->
            <div class="tab-pane fade show active p-3" id="week" role="tabpanel">
                <div class=" bg-white bg-white mb-4 overflow-auto">
                    <table id="myTable" class="min-w-full table-auto border-collapse">
                        <thead class="bg-gray-200">
                        <tr>
                            <th class="border px-4 py-2 text-left">#</th>
                            <th class="border px-4 py-2 text-left">Ngày nhập</th>
                            <th class="border px-4 py-2 text-left">Nhân viên</th>
                            <th class="border px-4 py-2 text-left">Số lượng</th>
                            <th class="border px-4 py-2 text-left">Giá</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="item, stat : ${results}" class="odd:bg-white even:bg-gray-50">
                            <td class="border px-4 py-2" th:text="${stat.index + 1}"></td>
                            <td class="border px-4 py-2" th:text="${item.ngayNhap}"></td>
                            <td class="border px-4 py-2" th:text="${item.TenNV}"></td>
                            <td class="border px-4 py-2" th:text="${item.soLuong}"></td>
                            <td class="border px-4 py-2" th:text="${item.donGiaShow}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>


            <!-- TAB 2 -->
            <div class="tab-pane fade p-3" id="excel" role="tabpanel">


                <form th:action="@{/material/importExcel}" id="excelForm" method="post" enctype="multipart/form-data">
                    <input type="hidden" name="dataImportJson" id="dataImportJson">
                    <div class="mb-3">
                        <label class="form-label">Chọn file Excel</label>
                        <input type="file" name="file" accept=".xlsx,.xls" id="fileInput" class="form-control" required>
                    </div>

                    <button type="submit" class="btn btn-primary">Import nhập hàng</button>

                </form>

                <hr class="my-4"/>

                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th>MaNL</th>
                        <th>SoLuong</th>
                        <th>DonGia</th>
                    </tr>
                    </thead>

                    <tbody id="dataImport">
                    </tbody>
                </table>

            </div>

        </div>

    </div>
</div>


<div layout:fragment="scripts">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        $('#myTable').DataTable({
          language: {
            search: "Tìm kiếm:",
            paginate: {
              previous: "Trước",
              next: "Sau"
            }
          }
        });

    document.getElementById("fileInput").addEventListener("change", function (e) {
        let file = e.target.files[0];
        if (!file) return;

        let reader = new FileReader();

        reader.onload = function (evt) {
            let data = evt.target.result;
            let workbook = XLSX.read(data, { type: "binary" });
            let sheet = workbook.Sheets[workbook.SheetNames[0]];
            let rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            let tbody = document.getElementById("dataImport");
            tbody.innerHTML = "";

            for (let i = 1; i < rows.length; i++) {
                let r = rows[i];
                if (!r || r.length === 0) continue;

                let tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${r[0] || ""}</td>
                    <td>${r[1] || ""}</td>
                    <td>${r[2] || ""}</td>
                `;

                tbody.appendChild(tr);
            }
        };

        reader.readAsBinaryString(file);
    });

    document.getElementById("excelForm").addEventListener("submit", function (e) {

        const rows = document.querySelectorAll("#dataImport tr");
        let data = [];

        rows.forEach(row => {
            let cells = row.querySelectorAll("td");

            data.push({
                maNL: cells[0].innerText.trim(),
                soLuong: cells[1].innerText.trim(),
                donGia: cells[2].innerText.trim()
            });
        });

        document.getElementById("dataImportJson").value = JSON.stringify(data);

    });
    </script>
</div>

</body>
</html>
